@page "/Course/Assigment/{ID:guid}"
@using PADatabase.Models
@using System.IO
@inject PAPublic.IPdfService assignmentService
@using Microsoft.AspNetCore.Components.Forms

@inject ApplicationDbContext _context
@inject IJSRuntime jsRuntime

<h3>Assignments</h3>

<div style="float:left;margin-right:5px;">
    <label>Title of Assignment</label>
    <input type="text" @bind="assigmet.Title" />
    <label>Due Date</label>
    <input type="date" @bind="assigmet.DueDate" />
    <label>Description</label>
    <input type="text" @bind="assigmet.Description" />
</div>

<button class="btn btn-success" style="float:left;margin-right:5px;" @onclick="SaveAssignment">Save</button>
<button class="btn btn-primary" style="float:left;" @onclick="AddNew">Add New</button>

<table class="table table-striped table-bordered">
    <thead>
        <tr>
            <th>Title</th>
            <th>Description</th>
            <th>Due Date</th>
            <th>Upload PDF</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var item in assigmenmtList)
        {
            <tr>
                <td>@item.Title</td>
                <td>@item.Description</td>
                <td>@item.DueDate</td>
                <td>
                    <InputFile OnChange="@(e => HandleFileSelected(e, item.Id))" />
                </td>
                <td>
                    <button class="btn btn-primary" @onclick="() => EditAssignment(item)">Edit</button>
                    <button class="btn btn-primary" @onclick="() => DeletAssigment(item)">Delete</button>
                    @if (item.PdfData != null)
                    {
                        <button class="btn btn-primary" @onclick="() => DownloadPdf(item.Id)">Download PDF</button>
                        <button class="btn btn-danger" @onclick="() => DeletePdf(item.Id)">Delete PDF</button>
                    }
                </td>
            </tr>
        }
    </tbody>
</table>

@code {
    [Parameter]
    public Guid ID { get; set; }

    Assignment assigmet = new Assignment();
    List<Assignment> assigmenmtList = new List<Assignment>();

    protected override async Task OnInitializedAsync()
    {
        GetAllAssignments();
    }

    private void GetAllAssignments()
    {
        assigmenmtList = assignmentService.GetAssimgents(ID);
    }

    private void AddNew()
    {
        assigmet = new Assignment();
    }

    private void SaveAssignment()
    {
        if (assigmet.Id == Guid.Empty)
        {
            // Add new assignment
            assignmentService.Save(assigmet, ID);
        }
        else
        {
            // Update existing assignment
            assignmentService.Update(assigmet);
        }
        assigmet = new Assignment();
        GetAllAssignments();
    }

    async void HandleFileSelected(InputFileChangeEventArgs e, Guid assignmentId)
    {
        var attach = await FileSender(e.File);
        assignmentService.Upload(assignmentId, attach);
        GetAllAssignments(); // Update the list after upload
    }

    public async Task<byte[]> FileSender(IBrowserFile file)
    {
        using var ms = new MemoryStream();
        await file.OpenReadStream(maxAllowedSize: 5242880).CopyToAsync(ms); // 5 MB limit
        return ms.ToArray();
    }

    private void DeletePdf(Guid assignmentId)
    {
        assignmentService.Delete(assignmentId);
        GetAllAssignments();
    }

    public async void DeletAssigment(Assignment a)
    {
        _context.Assignments.Remove(a);
        await _context.SaveChangesAsync();
        assigmenmtList.Remove(a);
        StateHasChanged();
    }

    private async Task DownloadPdf(Guid assignmentId)
    {
        var assignment = assigmenmtList.FirstOrDefault(x => x.Id == assignmentId);
        if (assignment != null && assignment.PdfData != null)
        {
            await jsRuntime.InvokeVoidAsync("saveAsFile", assignment.Title + ".pdf", Convert.ToBase64String(assignment.PdfData));
        }
        GetAllAssignments();
    }

    private void EditAssignment(Assignment assignment)
    {
        assigmet = assignment;
    }
}
